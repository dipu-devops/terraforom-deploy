variables:
- group: dev-secrets
- group: dev-config

stages:
  - stage: Plan
    displayName: "Terraform Plan"
    jobs:
    - job: Plan_Job
      pool: 'Default'
      steps:
      - checkout: self
      
      # Install Terraform
      - task: TerraformInstaller@0
        inputs:
          terraformVersion: $(tf_version)
          
      - script: |
          echo "Configuring Terraform environment variables"
          export ARM_CLIENT_ID=$(ARM_CLIENT_ID)
          export ARM_CLIENT_SECRET=$(ARM_CLIENT_SECRET)
          export ARM_TENANT_ID=$(ARM_TENANT_ID)
          export ARM_SUBSCRIPTION_ID=$(ARM_SUBSCRIPTION_ID)
          
        displayName: 'Set Terraform Environment Variables'
        
      # Terraform Init
      - task: TerraformTask@5
        inputs:
          provider: 'azurerm'
          command: 'init'
          workingDirectory: '$(System.DefaultWorkingDirectory)'
          commandOptions: '-reconfigure'
          backendServiceArm: 'Insight-pay-as-go(2ba2da7b-7bc1-4d9e-93f5-3db94434f2bc)'
          
      # Terraform Plan
      - task: TerraformTask@5
        inputs:
          provider: 'azurerm'
          command: 'plan'
          workingDirectory: '$(System.DefaultWorkingDirectory)'
          commandOptions: '-out=tfplan -var="environment=$(environment)"'
          
      - publish: $(System.DefaultWorkingDirectory)/tfplan
        artifact: tfplan

  - stage: Apply
    displayName: "Apply Changes"
    dependsOn: Plan
    condition: succeeded()
    jobs:
    - deployment: Apply_Job
      environment: Dev-Apply
      strategy:
        runOnce:
          deploy:
            steps:
            - download: current
              artifact: tfplan
              
            - script: |
                export ARM_CLIENT_ID=$(ARM_CLIENT_ID)
                export ARM_CLIENT_SECRET=$(ARM_CLIENT_SECRET)
                export ARM_TENANT_ID=$(ARM_TENANT_ID)
                export ARM_SUBSCRIPTION_ID=$(ARM_SUBSCRIPTION_ID)
                
              displayName: 'Set Environment Variables'
              
            # Install Terraform
            - task: TerraformInstaller@0
              inputs:
                terraformVersion: $(tf_version)
                
            # Terraform Apply
            - task: TerraformTask@5
              inputs:
                provider: 'azurerm'
                command: 'apply'
                commandOptions: '$(Pipeline.Workspace)/tfplan/tfplan'
                
            - script: |
                echo "Verifying state file"
                az storage blob show \
                  --account-name $(STORAGE_ACCOUNT_NAME) \
                  --container-name $(container_name) \
                  --name $(STATE_KEY) \
                  --auth-mode login
              displayName: 'State File Validation'
              env:
                AZURE_CLIENT_ID: $(ARM_CLIENT_ID)
                AZURE_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
                AZURE_TENANT_ID: $(ARM_TENANT_ID)